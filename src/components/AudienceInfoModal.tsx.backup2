'use client';

import { useState, useEffect, useRef } from 'react';
import { createPayAppPayment } from '@/services/payappService';

interface AudienceInfo {
  name: string;
  phone: string;
  attendeeCount: number;
  busService: boolean;
  busAttendeeCount: number;
  privacyAgreement: boolean;
}

interface FormErrors {
  name?: string;
  phone?: string;
  attendeeCount?: string;
  busAttendeeCount?: string;
  privacyAgreement?: string;
}

interface AudienceInfoModalProps {
  isVisible: boolean;
  onClose: () => void;
  onComplete: (info: AudienceInfo) => void;
  onShowPerformanceInfo: () => void;
  propName: string;
  propId: number; // ë¬¼í’ˆ ID ì¶”ê°€
}

declare global {
  interface Window {
    customKeyboard: any;
    ReactKeyboardInput?: (text: string) => void;
    ReactKeyboardEnter?: () => void;
    ReactKeyboardEsc?: () => void;
  }
}

export default function AudienceInfoModal({ 
  isVisible, 
  onClose, 
  onComplete, 
  onShowPerformanceInfo,
  propName,
  propId
}: AudienceInfoModalProps) {
  const [formData, setFormData] = useState<AudienceInfo>({
    name: '',
    phone: '',
    attendeeCount: 1,
    busService: false,
    busAttendeeCount: 1,
    privacyAgreement: false
  });

  const [errors, setErrors] = useState<FormErrors>({});
  const [showKeyboard, setShowKeyboard] = useState(false);
  const [activeField, setActiveField] = useState<'name' | 'phone' | null>(null);
  const keyboardRef = useRef<HTMLDivElement>(null);
  const nameInputRef = useRef<HTMLInputElement>(null);
  const phoneInputRef = useRef<HTMLInputElement>(null);
  
  // ê²°ì œ ê´€ë ¨ ìƒíƒœ
  const [showPayment, setShowPayment] = useState(false);
  const [paymentStatus, setPaymentStatus] = useState<'pending' | 'success' | 'failed'>('pending');
  const [isLoading, setIsLoading] = useState(false);
  const [showConfirmation, setShowConfirmation] = useState(false);
  const [showReceiptConfirm, setShowReceiptConfirm] = useState(false);

  // í‚¤ë³´ë“œ ì´ˆê¸°í™”
  useEffect(() => {
    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
    const loadScripts = async () => {
      if (typeof window !== 'undefined' && !window.customKeyboard) {
        try {
          console.log('ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì‹œì‘...');
          
          // Hangul.js ë¡œë“œ
          const hangulScript = document.createElement('script');
          hangulScript.src = '/hangul.js';
          hangulScript.async = true;
          
          // Keyboard.js ë¡œë“œ
          const keyboardScript = document.createElement('script');
          keyboardScript.src = '/keyboard.js';
          keyboardScript.async = true;

          // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
          await new Promise((resolve, reject) => {
            hangulScript.onload = () => {
              console.log('Hangul.js ë¡œë“œ ì™„ë£Œ');
            };
            hangulScript.onerror = (e) => {
              console.error('Hangul.js ë¡œë“œ ì‹¤íŒ¨:', e);
              reject(new Error('Hangul.js ë¡œë“œ ì‹¤íŒ¨'));
            };
            
            keyboardScript.onload = () => {
              console.log('Keyboard.js ë¡œë“œ ì™„ë£Œ');
              // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í›„ ì ì‹œ ëŒ€ê¸°
              setTimeout(() => {
                console.log('window.customKeyboard í™•ì¸:', typeof window.customKeyboard);
                resolve(true);
              }, 100);
            };
            keyboardScript.onerror = (e) => {
              console.error('Keyboard.js ë¡œë“œ ì‹¤íŒ¨:', e);
              reject(new Error('Keyboard.js ë¡œë“œ ì‹¤íŒ¨'));
            };
            
            document.head.appendChild(hangulScript);
            document.head.appendChild(keyboardScript);
          });
          
          console.log('ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
        } catch (error) {
          console.error('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      } else {
        console.log('ì´ë¯¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë¨:', typeof window.customKeyboard);
      }
    };

    loadScripts();

    // ì „ì—­ ì½œë°± í•¨ìˆ˜ ë“±ë¡
    if (typeof window !== 'undefined') {
      window.ReactKeyboardInput = handleKeyboardInput;
      window.ReactKeyboardEnter = handleKeyboardEnter;
      window.ReactKeyboardEsc = handleKeyboardEsc;
    }

    // í´ë¦°ì—…
    return () => {
      if (typeof window !== 'undefined') {
        window.ReactKeyboardInput = undefined;
        window.ReactKeyboardEnter = undefined;
        window.ReactKeyboardEsc = undefined;
      }
    };
  }, []);

  // í‚¤ë³´ë“œ í‘œì‹œ ì‹œ ì´ˆê¸°í™”
  useEffect(() => {
    if (showKeyboard && keyboardRef.current && window.customKeyboard) {
      const input = activeField === 'name' ? nameInputRef.current : phoneInputRef.current;
      
      if (input) {
        try {
          // ê¸°ì¡´ í‚¤ë³´ë“œ ì œê±°
          if (keyboardRef.current.children.length > 0) {
            keyboardRef.current.innerHTML = '';
          }
          
          // í•¸ë“œí° ë²ˆí˜¸ ì…ë ¥ ì‹œ ì»¤ìŠ¤í…€ ìˆ«ì í‚¤íŒ¨ë“œ ìƒì„±
          if (activeField === 'phone') {
            // ê¸°ì¡´ í‚¤ë³´ë“œ ì œê±°
            keyboardRef.current.innerHTML = '';
            
            // phoneNumber ë ˆì´ì•„ì›ƒ ì‚¬ìš©
            const keyboard = new window.customKeyboard(
              keyboardRef.current,
              input,
              (text: string) => {
                console.log('í‚¤ë³´ë“œ ì…ë ¥:', text);
                handleKeyboardInput(text);
              },
              () => {
                console.log('ESC í‚¤');
                handleKeyboardEsc();
              },
              (e: any) => {
                console.log('Enter í‚¤');
                handleKeyboardEnter();
              },
              'phoneNumber'
            );
            
            console.log('ìˆ«ì í‚¤íŒ¨ë“œ ìƒì„± ì™„ë£Œ');
          } else {
            // ì´ë¦„ ì…ë ¥ ì‹œ ê¸°ì¡´ í‚¤ë³´ë“œ ì‚¬ìš© (ìˆ˜ì •ëœ ìŠ¤í¬ë¦½íŠ¸ë¡œ koNormal ê¸°ë³¸ê°’)
            const keyboard = new window.customKeyboard(
              keyboardRef.current,
              input,
              (text: string) => {
                console.log('í‚¤ë³´ë“œ ì…ë ¥:', text);
                handleKeyboardInput(text);
              },
              () => {
                console.log('ESC í‚¤');
                handleKeyboardEsc();
              },
              (e: any) => {
                console.log('Enter í‚¤');
                handleKeyboardEnter();
              },
              null
            );
            
            console.log('í•œê¸€ í‚¤ë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ (koNormal ê¸°ë³¸ê°’)');
          }
        } catch (error) {
          console.error('í‚¤ë³´ë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          if (error instanceof Error) {
            console.error('ì—ëŸ¬ ìƒì„¸:', error.message);
            console.error('ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
          }
        }
      }
    }
  }, [showKeyboard, activeField]);

  // í‚¤ë³´ë“œ í‘œì‹œ/ìˆ¨ê¹€
  const toggleKeyboard = (field: 'name' | 'phone') => {
    if (activeField === field) {
      setShowKeyboard(false);
      setActiveField(null);
    } else {
      setActiveField(field);
      setShowKeyboard(true);
    }
  };

  // í‚¤ë³´ë“œ ì…ë ¥ ì²˜ë¦¬
  const handleKeyboardInput = (text: string) => {
    if (activeField === 'name') {
      setFormData(prev => ({ ...prev, name: text }));
    } else if (activeField === 'phone') {
      setFormData(prev => ({ ...prev, phone: text }));
    }
  };

  // í‚¤ë³´ë“œ Enter ì²˜ë¦¬
  const handleKeyboardEnter = () => {
    setShowKeyboard(false);
    setActiveField(null);
  };

  // í‚¤ë³´ë“œ ESC ì²˜ë¦¬
  const handleKeyboardEsc = () => {
    setShowKeyboard(false);
    setActiveField(null);
  };

  // ì¹´ì¹´ì˜¤ë§µ ì‹¤ì œ ì§€ë„í¼ê°€ê¸° HTML ì‚½ì… (ì´ë¯¸ì§€ í¬ê¸°ì— ë§ì¶¤)
  useEffect(() => {
    if (isVisible) {
      const mapContainer = document.getElementById('daumRoughmapContainer1755930369777');
      if (mapContainer) {
        mapContainer.innerHTML = `
          <div style="font:normal normal 400 12px/normal dotum, sans-serif; width:100%; height:100%; color:#333; position:relative">
            <div style="height: 100%;">
              <img class="map" src="http://t1.daumcdn.net/roughmap/imgmap/3d955c01aac6028aae05cffeb42ea9932d383dec93bc02592915bf7c521fab66" width="100%" height="100%" style="border:1px solid #ccc; object-fit: cover;">
            </div>
            <div style="overflow: hidden; padding: 7px 11px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 0px 0px 2px 2px; background-color: rgb(249, 249, 249);">
              <div style="float: left;">
                <img src="//t1.daumcdn.net/localimg/localimages/07/2018/pc/common/logo_kakaomap.png" width="72" height="16" alt="ì¹´ì¹´ì˜¤ë§µ" style="display:block;width:72px;height:16px">
              </div>
              <div style="float: right; position: relative; top: 1px; font-size: 11px; color: #666;">
                ìœ„ì¹˜ ì •ë³´
              </div>
            </div>
          </div>
        `;
      }
    }
  }, [isVisible]);

  if (!isVisible) return null;

  const validateForm = () => {
    const newErrors: FormErrors = {};
    
    if (!formData.name.trim()) {
      newErrors.name = 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”';
    }
    
    if (!formData.phone.trim()) {
      newErrors.phone = 'ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
    } else if (!/^[0-9-]+$/.test(formData.phone)) {
      newErrors.phone = 'ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤';
    }
    
    if (!formData.privacyAgreement) {
      newErrors.privacyAgreement = 'ê°œì¸ì •ë³´ ì´ìš©ì— ë™ì˜í•´ì£¼ì„¸ìš”';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (validateForm()) {
      // í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
      setShowConfirmation(true);
    }
  };

  const handleConfirmPayment = async () => {
    setShowConfirmation(false);
    // ê´€ê° ì •ë³´ ì…ë ¥ ì™„ë£Œ í›„ ê²°ì œ ì‹œì‘
    setShowPayment(true);
    await startPayment();
  };

  const startPayment = async () => {
    setIsLoading(true);
    setPaymentStatus('pending');
    
    try {
      // ì¸ì› ìˆ˜ì— ë”°ë¥¸ ê²°ì œ ê¸ˆì•¡ ê³„ì‚° (1ëª…ë‹¹ 20,000ì›)
      const totalPrice = formData.attendeeCount * 20000;
      
      // PayApp ê²°ì œ ìš”ì²­ ìƒì„±
      const paymentData = {
        userid: 'jiwonnnnnn',
        shopname: 'ë¶€ì¬ì‹œ í”½ì…˜ì€ ë¬¸ ì•ì— ë†”ì£¼ì„¸ìš”',
        goodname: `${propName} - ${formData.attendeeCount}ëª…`,
        price: totalPrice,
        recvphone: formData.phone,
        memo: `${propName} ê³µì—° ì˜ˆë§¤ - ${formData.attendeeCount}ëª…`,
        redirecturl: window.location.origin + '/payment-success',
        feedbackurl: window.location.origin + '/api/payment-callback',
        var1: 'performance_ticket',
        var2: JSON.stringify(formData) // ê´€ê° ì •ë³´ë¥¼ var2ì— ì €ì¥
      };

      const response = await createPayAppPayment(paymentData);
      
      if (response.state === '1' && response.payurl) {
        // ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì‹œë®¬ë ˆì´ì…˜
        if (process.env.NODE_ENV === 'development') {
          console.log('ê°œë°œ í™˜ê²½: ê²°ì œ ì„±ê³µ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘');
          setTimeout(() => {
            console.log('ê²°ì œ ìƒíƒœë¥¼ successë¡œ ë³€ê²½');
            setPaymentStatus('success');
            // 2ì´ˆ í›„ ìë™ìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬
            setTimeout(() => {
              console.log('handlePaymentSuccess í˜¸ì¶œ');
              handlePaymentSuccess();
            }, 2000);
          }, 3000); // 3ì´ˆ í›„ ì„±ê³µ ì‹œë®¬ë ˆì´ì…˜
        } else {
          // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” PayAppìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          window.location.href = response.payurl;
        }
      } else {
        throw new Error(response.errorMessage || 'ê²°ì œ ìš”ì²­ ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('ê²°ì œ ì‹œì‘ ì˜¤ë¥˜:', error);
      setPaymentStatus('failed');
    } finally {
      setIsLoading(false);
    }
  };

  const handlePaymentSuccess = async () => {
    console.log('handlePaymentSuccess í•¨ìˆ˜ ì‹œì‘');
    try {
      // ë°ì´í„° ì €ì¥
      const response = await fetch('/api/audience/save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: formData.name,
          phone: formData.phone,
          attendeeCount: formData.attendeeCount,
          busService: formData.busService,
          busDetails: formData.busService ? { attendeeCount: formData.busAttendeeCount } : null,
          privacyAgreement: formData.privacyAgreement,
          propId: propId,
          propName: propName,
          paymentAmount: formData.attendeeCount * 20000, // 1ì¸ë‹¹ 20,000ì›
          payappMulNo: null, // PayApp ê²°ì œ ë²ˆí˜¸ëŠ” ë³„ë„ë¡œ ê´€ë¦¬
        }),
      });

      if (response.ok) {
        // ì´ë©”ì¼ ì „ì†¡
        try {
          console.log('ì´ë©”ì¼ ì „ì†¡ ì‹œë„...');
          const emailResponse = await fetch('/api/email/send', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name: formData.name,
              phone: formData.phone,
              attendeeCount: formData.attendeeCount,
              busService: formData.busService,
              busAttendeeCount: formData.busAttendeeCount,
              propName: propName,
            }),
          });
          
          if (emailResponse.ok) {
            console.log('ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ');
          } else {
            console.error('ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨:', emailResponse.status, emailResponse.statusText);
          }
        } catch (emailError) {
          console.error('ì´ë©”ì¼ ì „ì†¡ ì˜¤ë¥˜:', emailError);
          // ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨ëŠ” ì „ì²´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ
        }

        // í•´ë‹¹ ë¬¼í’ˆì„ ì£¼ë¬¸ ì™„ë£Œ ìƒíƒœë¡œ í‘œì‹œ
        if (typeof window !== 'undefined' && (window as any).handlePropCompleted) {
          console.log('handlePropCompleted í˜¸ì¶œ:', propId);
          (window as any).handlePropCompleted(propId);
        }

        // ê²°ì œ ëª¨ë‹¬ ë‹«ê¸°
        setShowPayment(false);
        
        // ì˜ìˆ˜ì¦ ì¶œë ¥ ì—¬ë¶€ í™•ì¸
        console.log('ì˜ìˆ˜ì¦ ì¶œë ¥ ì„ íƒì°½ í‘œì‹œ');
        setShowReceiptConfirm(true);
        
        // ì„±ê³µì ìœ¼ë¡œ ì €ì¥ëœ ê²½ìš° (ì˜ìˆ˜ì¦ ì¶œë ¥ í›„ì— í˜¸ì¶œ)
        // onComplete(formData);
      } else {
        const errorData = await response.json();
        console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', errorData);
        throw new Error(errorData.error || 'ë°ì´í„° ì €ì¥ ì‹¤íŒ¨');
      }
    } catch (error) {
      console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
      
      // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì˜ìˆ˜ì¦ ì¶œë ¥ ì„ íƒì°½ì€ í‘œì‹œ
      setShowPayment(false);
      setShowReceiptConfirm(true);
      
      // ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
      alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
  };

  // ì˜ìˆ˜ì¦ í”„ë¦°íŠ¸ í•¨ìˆ˜
  const printReceipt = () => {
    // í”„ë¦°íŠ¸ìš© ì˜ìˆ˜ì¦ HTML ìƒì„±
    const receiptHTML = `
      <!DOCTYPE html>
      <html>
        <head>
          <title>Receipt</title>
          <style>
            @page {
              margin: 0;
              size: 80mm 200mm;
            }
            @media print {
              @page {
                margin: 0;
                size: 80mm 200mm;
              }
              body { 
                margin: 0; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
              }
              .receipt { 
                max-width: none; 
                width: 100%;
              }
              /* í”„ë¦°íŠ¸ ì‹œ ë¸Œë¼ìš°ì € í—¤ë”/í‘¸í„° ìˆ¨ê¸°ê¸° */
              html, body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
              }
              /* ìë™ ì¸ì‡„ ê°•ì œ */
              * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
              }
            }
            body { 
              margin: 0; 
              padding: 5px 10px; 
              font-family: Arial, sans-serif; 
              font-size: 11px; 
              line-height: 1.3;
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
            }
            .receipt { 
              width: 100%; 
              max-width: 70mm; 
              margin: 0 auto; 
              padding-top: 0;
            }
            .section { 
              margin-bottom: 12px; 
            }
            .section-title { 
              font-weight: bold; 
              margin-bottom: 4px; 
              border-bottom: 1px solid #000; 
              padding-bottom: 2px; 
            }
            .info-row { 
              display: flex; 
              justify-content: space-between; 
              margin-bottom: 2px; 
            }
            .total { 
              font-weight: bold; 
              font-size: 13px; 
              margin-top: 12px; 
              padding-top: 8px; 
              border-top: 2px solid #000; 
            }
          </style>
        </head>
        <body>
          <div class="receipt">
            <div class="section" style="margin-top: 0;">
              <div class="section-title">ê³µì—° ì •ë³´</div>
              <div class="info-row">
                <span>ê³µì—°ëª…:</span>
                <span>ã€ˆë¶€ì¬ì‹œ í”½ì…˜ì€ ë¬¸ ì•ì— ë†”ì£¼ì„¸ìš”ã€‰</span>
              </div>
              <div class="info-row">
                <span>ê³µì—°ì¼ì‹œ:</span>
                <span>2025ë…„ 10ì›” 30ì¼</span>
              </div>
              <div class="info-row">
                <span>ì¥ì†Œ:</span>
                <span>ì „ì‹œì¥</span>
              </div>
              <div class="info-row">
                <span>ì„ íƒ ì†Œí’ˆ:</span>
                <span>${propName}</span>
              </div>
            </div>
            
            <div class="section">
              <div class="section-title">ê´€ê° ì •ë³´</div>
              <div class="info-row">
                <span>ì´ë¦„:</span>
                <span>${formData.name}</span>
              </div>
              <div class="info-row">
                <span>ì—°ë½ì²˜:</span>
                <span>${formData.phone}</span>
              </div>
              <div class="info-row">
                <span>ê´€ëŒ ì¸ì›:</span>
                <span>${formData.attendeeCount}ëª…</span>
              </div>
            </div>
            
            ${formData.busService ? `
            <div class="section">
              <div class="section-title">ë²„ìŠ¤ ì„œë¹„ìŠ¤</div>
              <div class="info-row">
                <span>ë²„ìŠ¤ ì´ìš©:</span>
                <span>ì˜ˆ</span>
              </div>
              <div class="info-row">
                <span>ë²„ìŠ¤ ì´ìš© ì¸ì›:</span>
                <span>${formData.busAttendeeCount}ëª…</span>
              </div>
            </div>
            ` : ''}
            
            <div class="section">
              <div class="section-title">ê²°ì œ ì •ë³´</div>
              <div class="info-row">
                <span>ê²°ì œ ê¸ˆì•¡:</span>
                <span>${(formData.attendeeCount * 20000).toLocaleString()}ì›</span>
              </div>
              <div class="info-row">
                <span>ê²°ì œ ì¼ì‹œ:</span>
                <span>${new Date().toLocaleString('ko-KR')}</span>
              </div>
            </div>
            
            <div class="total">
              ì´ ê²°ì œ ê¸ˆì•¡: ${(formData.attendeeCount * 20000).toLocaleString()}ì›
            </div>
            
            <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666;">
              ë¬¸ì˜ì‚¬í•­: 010-7168-6144
            </div>
          </div>
        </body>
      </html>
    `;

    try {
      console.log('ì˜ìˆ˜ì¦ í”„ë¦°íŠ¸ ì‹œì‘');
      
      // ìƒˆë¡œìš´ ë°©ì‹: window.openìœ¼ë¡œ í”„ë¦°í„° ì°½ ìµœì†Œí™”
      try {
        console.log('window.open ë°©ì‹ìœ¼ë¡œ í”„ë¦°íŠ¸ ì‹œë„...');
        
        // ìƒˆ ì°½ì„ ì—´ì–´ì„œ ì˜ìˆ˜ì¦ í‘œì‹œ
        const printWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
        
        if (printWindow) {
          // ì˜ìˆ˜ì¦ HTMLì„ ìƒˆ ì°½ì— ì‘ì„±
          printWindow.document.write(receiptHTML);
          printWindow.document.close();
          
          // ìƒˆ ì°½ì´ ë¡œë“œëœ í›„ ìë™ í”„ë¦°íŠ¸ ì‹œë„
          printWindow.onload = () => {
            console.log('ìƒˆ ì°½ ë¡œë“œ ì™„ë£Œ, ìë™ í”„ë¦°íŠ¸ ì‹œì‘');
            
            // ì—¬ëŸ¬ ë²ˆ í”„ë¦°íŠ¸ ì‹œë„
            const attemptPrint = () => {
              try {
                printWindow.print();
                console.log('í”„ë¦°íŠ¸ ëª…ë ¹ ì‹¤í–‰ë¨');
                
                // í”„ë¦°íŠ¸ ì™„ë£Œ í›„ ì°½ ë‹«ê¸°
                setTimeout(() => {
                  printWindow.close();
                  console.log('í”„ë¦°íŠ¸ ì°½ ë‹«í˜');
                }, 1000);
              } catch (error) {
                console.error('í”„ë¦°íŠ¸ ì‹œë„ ì‹¤íŒ¨:', error);
              }
            };
            
            // ì¦‰ì‹œ í”„ë¦°íŠ¸
            attemptPrint();
            
            // ë°±ì—…: ì—¬ëŸ¬ ë²ˆ ì‹œë„
            setTimeout(attemptPrint, 100);
            setTimeout(attemptPrint, 300);
            setTimeout(attemptPrint, 500);
          };
          
          // ë°±ì—…: onloadê°€ ì‘ë™í•˜ì§€ ì•Šì„ ê²½ìš°
          setTimeout(() => {
            if (printWindow.document.readyState === 'complete') {
              console.log('ë°±ì—… í”„ë¦°íŠ¸ ì‹œë„');
              printWindow.print();
              setTimeout(() => printWindow.close(), 1000);
            }
          }, 200);
          
        } else {
          throw new Error('ìƒˆ ì°½ì„ ì—´ ìˆ˜ ì—†ìŒ');
        }
        
      } catch (error) {
        console.error('window.open ë°©ì‹ ì‹¤íŒ¨, iframe ë°©ì‹ìœ¼ë¡œ fallback:', error);
        
                // ê¸°ì¡´ iframe ë°©ì‹ìœ¼ë¡œ fallback
        const printFrame = document.createElement('iframe');
        printFrame.style.display = 'none';
        document.body.appendChild(printFrame);
        
        printFrame.contentDocument?.write(receiptHTML);
        printFrame.contentDocument?.close();
        
        // iframe í”„ë¦°íŠ¸ ì‹œë„
        printFrame.onload = () => {
          try {
            printFrame.contentWindow?.print();
            console.log('iframe fallback í”„ë¦°íŠ¸ ì„±ê³µ');
            
            setTimeout(() => {
              document.body.removeChild(printFrame);
            }, 1000);
          } catch (error) {
            console.error('iframe fallback í”„ë¦°íŠ¸ ì‹¤íŒ¨:', error);
          }
        };
      }

    } catch (error) {
      console.error('í”„ë¦°íŠ¸ í•¨ìˆ˜ ì˜¤ë¥˜:', error);
      try {
        window.print();
      } catch (fallbackError) {
        console.error('ê¸°ë³¸ í”„ë¦°íŠ¸ë„ ì‹¤íŒ¨:', fallbackError);
      }
    }
  };

  const handleInputChange = (field: keyof AudienceInfo, value: string | boolean | number) => {
    setFormData(prev => {
      const newData = { ...prev, [field]: value };
      
      // ì „ì²´ ì¸ì› ìˆ˜ê°€ ë³€ê²½ë˜ê³ , ëŒ€ì ˆë²„ìŠ¤ íƒ‘ìŠ¹ ì¸ì›ì´ ì „ì²´ ì¸ì› ìˆ˜ë¥¼ ì´ˆê³¼í•˜ëŠ” ê²½ìš° ë³´ì •
      if (field === 'attendeeCount' && typeof value === 'number' && newData.busAttendeeCount > value) {
        newData.busAttendeeCount = value;
      }
      
      return newData;
    });
    
    // ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
    if (errors[field as keyof FormErrors]) {
      setErrors(prev => ({ ...prev, [field as keyof FormErrors]: undefined }));
    }
  };

  // ê²°ì œ ëª¨ë‹¬ì´ í‘œì‹œë˜ëŠ” ê²½ìš°
  if (showPayment) {
    return (
      <div className="fixed inset-0 bg-black/70 z-60 flex items-center justify-center p-5">
        <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6">
          <div className="text-center">
            <h3 className="text-xl font-bold mb-4">ê²°ì œ ì§„í–‰ ì¤‘</h3>
            
            {paymentStatus === 'pending' && (
              <>
                <div className="mb-4">
                  <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-pink-600 mx-auto"></div>
                </div>
                <p className="text-sm text-gray-600 mb-4">
                  ê²°ì œë¥¼ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                </p>
                {isLoading && (
                  <div className="animate-pulse bg-blue-100 p-3 rounded-lg">
                    <p className="text-blue-800 text-sm">ê²°ì œ ìš”ì²­ ì¤‘...</p>
                  </div>
                )}
              </>
            )}

            {paymentStatus === 'success' && (
              <div className="text-green-600 mb-4">
                <div className="text-6xl mb-2">âœ…</div>
                <p className="text-lg font-bold">ê²°ì œ ì„±ê³µ!</p>
                <p className="text-sm text-gray-600 mt-1">ì ì‹œ í›„ ì™„ë£Œ ì²˜ë¦¬ë©ë‹ˆë‹¤...</p>
                <div className="mt-3">
                  <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600 mx-auto"></div>
                </div>
              </div>
            )}

            {paymentStatus === 'failed' && (
              <div className="text-red-600 mb-4">
                <div className="text-6xl mb-2">âŒ</div>
                <p className="text-lg font-bold">ê²°ì œ ì‹¤íŒ¨</p>
                <p className="text-sm text-gray-600 mt-1">ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</p>
              </div>
            )}

            <div className="flex gap-3 mt-6">
              {paymentStatus === 'success' ? (
                <button
                  onClick={handlePaymentSuccess}
                  className="flex-1 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors"
                >
                  ì™„ë£Œ
                </button>
              ) : (
                <>
                  <button
                    onClick={() => setShowPayment(false)}
                    className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                  >
                    ì·¨ì†Œ
                  </button>
                  
                  {paymentStatus === 'failed' && (
                    <button
                      onClick={startPayment}
                      className="flex-1 px-4 py-2 bg-pink-200 text-gray-800 rounded-md hover:bg-pink-300 transition-colors"
                    >
                      ë‹¤ì‹œ ì‹œë„
                    </button>
                  )}
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ì˜ìˆ˜ì¦ ì¶œë ¥ í™•ì¸ ëª¨ë‹¬ì´ í‘œì‹œë˜ëŠ” ê²½ìš°
  if (showReceiptConfirm) {
    return (
      <div className="fixed inset-0 bg-black/70 z-60 flex items-center justify-center p-5">
        <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6">
          <div className="text-center mb-6">
            <div className="text-6xl mb-4">ğŸ§¾</div>
            <h3 className="text-xl font-bold text-gray-800">ì˜ìˆ˜ì¦ ì¶œë ¥</h3>
            <p className="text-sm text-gray-600 mt-2">
              ì˜ˆë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!<br />
              ì˜ìˆ˜ì¦ì„ ì¶œë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>
          </div>

          <div className="bg-gray-50 p-4 rounded-lg mb-6">
            <h4 className="text-sm font-medium text-gray-800 mb-2">ì˜ˆë§¤ ì •ë³´ ìš”ì•½</h4>
            <div className="text-sm text-gray-700 space-y-1">
              <div className="flex justify-between">
                <span>ê³µì—°:</span>
                <span className="font-medium">ë¶€ì¬ì‹œ í”½ì…˜ì€ ë¬¸ ì•ì— ë†”ì£¼ì„¸ìš”</span>
              </div>
              <div className="flex justify-between">
                <span>ì†Œí’ˆ:</span>
                <span className="font-medium">{propName}</span>
              </div>
              <div className="flex justify-between">
                <span>ê´€ê°:</span>
                <span className="font-medium">{formData.name}</span>
              </div>
              <div className="flex justify-between">
                <span>ì¸ì›:</span>
                <span className="font-medium">{formData.attendeeCount}ëª…</span>
              </div>
              <div className="flex justify-between">
                <span>ê¸ˆì•¡:</span>
                <span className="font-medium text-pink-600">â‚©{(formData.attendeeCount * 20000).toLocaleString()}</span>
              </div>
            </div>
          </div>

          <div className="flex gap-3">
            <button
              onClick={() => {
                setShowReceiptConfirm(false);
                onComplete(formData);
              }}
              className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
            >
              ì¶œë ¥ ì•ˆí•¨
            </button>
            
            <button
              onClick={() => {
                setShowReceiptConfirm(false);
                printReceipt();
                // ì˜ìˆ˜ì¦ ì¶œë ¥ í›„ ì™„ë£Œ ì²˜ë¦¬
                setTimeout(() => {
                  onComplete(formData);
                }, 1000);
              }}
              className="flex-1 px-4 py-2 bg-pink-200 text-gray-800 hover:bg-pink-300 transition-colors font-medium"
            >
              ì˜ìˆ˜ì¦ ì¶œë ¥
            </button>
          </div>
        </div>
      </div>
    );
  }

  // í™•ì¸ ëª¨ë‹¬ì´ í‘œì‹œë˜ëŠ” ê²½ìš°
  if (showConfirmation) {
    return (
      <div className="fixed inset-0 bg-black/70 z-60 flex items-center justify-center p-5">
        <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
          <div className="text-center mb-6">
            <h3 className="text-xl font-bold text-gray-800">ì˜ˆë§¤ ì •ë³´ í™•ì¸</h3>
            <p className="text-sm text-gray-600 mt-1">ì…ë ¥í•˜ì‹  ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</p>
          </div>

          {/* ì˜ˆë§¤ ì •ë³´ ìš”ì•½ */}
          <div className="space-y-4 mb-6">
            {/* ê³µì—° ì •ë³´ */}
            <div className="p-4 rounded-lg border border-gray-300">
              <h4 className="text-sm font-medium text-pink-600 mb-2">ê³µì—° ì •ë³´</h4>
              <div className="space-y-2 text-sm text-gray-700">
                <div className="flex justify-between">
                  <span>ê³µì—°ëª…:</span>
                  <span className="font-medium">ë¶€ì¬ì‹œ í”½ì…˜ì€ ë¬¸ ì•ì— ë†”ì£¼ì„¸ìš”</span>
                </div>
                <div className="flex justify-between">
                  <span>ê³µì—°ì¼ì‹œ:</span>
                  <span className="font-medium">2024ë…„ 10ì›” 30ì¼ ì˜¤í›„ 7ì‹œ</span>
                </div>
                <div className="flex justify-between">
                  <span>ì¥ì†Œ:</span>
                  <span className="font-medium">í•©ì •ì—­ 2ë²ˆ ì¶œêµ¬ ì• ì„¸ì•„íƒ€ì›Œ</span>
                </div>
                <div className="flex justify-between">
                  <span>ì„ íƒ ì†Œí’ˆ:</span>
                  <span className="font-medium">{propName}</span>
                </div>
              </div>
            </div>

            {/* ê´€ê° ì •ë³´ */}
            <div className="p-4 rounded-lg border border-gray-300">
              <h4 className="text-sm font-medium text-pink-600 mb-2">ê´€ê° ì •ë³´</h4>
              <div className="space-y-2 text-sm text-gray-700">
                <div className="flex justify-between">
                  <span>ì´ë¦„:</span>
                  <span className="font-medium">{formData.name}</span>
                </div>
                <div className="flex justify-between">
                  <span>ì—°ë½ì²˜:</span>
                  <span className="font-medium">{formData.phone}</span>
                </div>
                <div className="flex justify-between">
                  <span>ê´€ëŒ ì¸ì›:</span>
                  <span className="font-medium">{formData.attendeeCount}ëª…</span>
                </div>
              </div>
            </div>

            {/* ëŒ€ì ˆë²„ìŠ¤ ì •ë³´ */}
            {formData.busService && (
              <div className="p-4 rounded-lg border border-gray-300">
                <h4 className="text-sm font-medium text-pink-600 mb-2">ëŒ€ì ˆë²„ìŠ¤ ì´ìš©</h4>
                <div className="space-y-2 text-sm text-gray-700">
                  <div className="flex justify-between">
                    <span>íƒ‘ìŠ¹ ì¸ì›:</span>
                    <span className="font-medium">{formData.busAttendeeCount}ëª…</span>
                  </div>
                  <div className="text-xs text-gray-600">
                    íƒ‘ìŠ¹ ìœ„ì¹˜: í•©ì •ì—­ 2ë²ˆ ì¶œêµ¬ ì• ì„¸ì•„íƒ€ì›Œ
                  </div>
                  <div className="text-xs text-gray-600">
                    íƒ‘ìŠ¹ ì‹œê°„: 10ì›” 30ì¼ ì˜¤í›„ 5ì‹œ
                  </div>
                </div>
              </div>
            )}

            {/* ê²°ì œ ì •ë³´ */}
            <div className="p-4 rounded-lg border border-gray-300">
              <h4 className="text-sm font-medium text-pink-600 mb-2">ê²°ì œ ì •ë³´</h4>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-700">ê´€ëŒ ì¸ì›:</span>
                  <span className="font-medium text-gray-800">{formData.attendeeCount}ëª…</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-700">1ì¸ë‹¹ ê°€ê²©:</span>
                  <span className="font-medium text-gray-800">â‚©20,000</span>
                </div>
                <div className="border-t border-gray-300 pt-2 mt-2">
                  <div className="flex justify-between">
                    <span className="text-pink-600 font-semibold">ì´ ê²°ì œ ê¸ˆì•¡:</span>
                    <span className="text-pink-600 font-bold text-lg">â‚©{(formData.attendeeCount * 20000).toLocaleString()}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* ì•ˆë‚´ì‚¬í•­ */}
          <div className="p-4 rounded-lg border border-gray-300 mb-6">
            <h4 className="text-sm font-medium text-pink-600 mb-2">ì•ˆë‚´ì‚¬í•­</h4>
            <ul className="text-xs text-gray-600 space-y-1">
              <li>â€¢ ì˜ˆë§¤ ì™„ë£Œ ì‹œ ì„ íƒí•˜ì‹  ì†Œí’ˆì´ ê³µì—°ì— ë“±ì¥í•©ë‹ˆë‹¤</li>
              <li>â€¢ ê²°ì œ ì™„ë£Œ í›„ ì˜ˆë§¤ í™•ì •ë©ë‹ˆë‹¤</li>
              <li>â€¢ ëŒ€ì ˆë²„ìŠ¤ ì´ìš© ì‹œ ì§€ì •ëœ ì‹œê°„ê³¼ ì¥ì†Œì—ì„œ íƒ‘ìŠ¹í•´ì£¼ì„¸ìš”</li>
              <li>â€¢ ë¬¸ì˜ì‚¬í•­ì€ 010-7168-6144ë¡œ ì—°ë½ì£¼ì„¸ìš”</li>
            </ul>
          </div>

          {/* ë²„íŠ¼ë“¤ */}
          <div className="flex gap-3">
            <button
              onClick={() => setShowConfirmation(false)}
              className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
            >
              ìˆ˜ì •í•˜ê¸°
            </button>
            
            <button
              onClick={handleConfirmPayment}
              className="flex-1 px-4 py-2 bg-pink-200 text-gray-800 hover:bg-pink-300 transition-colors font-medium"
            >
              ê²°ì œ ì§„í–‰
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-5">
      <div className="bg-white w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
        {/* í—¤ë” */}
        <div className="bg-pink-200 px-6 py-4 sticky top-0 relative">
          {/* X ë²„íŠ¼ */}
          <button
            onClick={onClose}
            className="absolute top-2 right-4 text-black text-4xl font-light hover:text-gray-700 transition-colors z-10"
          >
            Ã—
          </button>
          
          <h2 className="text-xl font-bold text-center text-black">
            ê³µì—° ì˜ˆë§¤
          </h2>
          <p className="text-sm text-center text-black mt-1">
            ì˜ˆë§¤ ì™„ë£Œì‹œ ì„ íƒí•´ì£¼ì‹  '{propName}'ì´(ê°€) ê³µì—°ì— ì†Œí’ˆìœ¼ë¡œ ë“±ì¥í•©ë‹ˆë‹¤.
          </p>
        </div>

        {/* í¼ */}
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          {/* ê´€ê° ì •ë³´ ì…ë ¥ ì œëª© */}
          <div className="text-center mb-6">
            <h3 className="text-lg font-bold text-gray-800">ê´€ê° ì •ë³´ ì…ë ¥</h3>
          </div>

          {/* ì´ë¦„ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ì´ë¦„ <span className="text-red-500">*</span>
            </label>
            <input
              id="name-input"
              ref={nameInputRef}
              type="text"
              value={formData.name}
              onChange={(e) => handleInputChange('name', e.target.value)}
              onFocus={() => toggleKeyboard('name')}
              readOnly
              className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-pink-300 bg-white ${
                errors.name ? 'border-red-500' : 'border-gray-300'
              } ${showKeyboard && activeField === 'name' ? 'ring-4 ring-pink-200 shadow-lg' : ''}`}
              placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
            />
            {errors.name && (
              <p className="text-red-500 text-sm mt-1">{errors.name}</p>
            )}
          </div>

          {/* ì—°ë½ì²˜ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              í•¸ë“œí° ë²ˆí˜¸ <span className="text-red-500">*</span>
            </label>
            <input
              id="phone-input"
              ref={phoneInputRef}
              type="text"
              value={formData.phone}
              onChange={(e) => handleInputChange('phone', e.target.value)}
              onFocus={() => toggleKeyboard('phone')}
              readOnly
              className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-pink-300 bg-white ${
                errors.phone ? 'border-red-500' : 'border-gray-300'
              } ${showKeyboard && activeField === 'phone' ? 'ring-4 ring-pink-200 shadow-lg' : ''}`}
              placeholder="010-1234-5678"
            />
            {errors.phone && (
              <p className="text-red-500 text-sm mt-1">{errors.phone}</p>
            )}
          </div>

          {/* ì¸ì› ìˆ˜ ì„ íƒ */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ì¸ì› ìˆ˜ <span className="text-red-500">*</span>
            </label>
            <select
              value={formData.attendeeCount}
              onChange={(e) => handleInputChange('attendeeCount', parseInt(e.target.value, 10))}
              className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-pink-300"
            >
              {[1, 2, 3, 4].map((count) => (
                <option key={count} value={count}>
                  {count}ëª…
                </option>
              ))}
            </select>
            {errors.attendeeCount && (
              <p className="text-red-500 text-sm mt-1">{errors.attendeeCount}</p>
            )}
          </div>

          {/* ëŒ€ì ˆë²„ìŠ¤ ì´ìš©ì—¬ë¶€ */}
          <div>
            <label className="flex items-center space-x-2 cursor-pointer">
              <input
                type="checkbox"
                checked={formData.busService}
                onChange={(e) => handleInputChange('busService', e.target.checked)}
                className="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500"
              />
              <span className="text-sm font-medium text-gray-700">
                ëŒ€ì ˆë²„ìŠ¤ ì´ìš©
              </span>
            </label>
          </div>

          {/* ëŒ€ì ˆë²„ìŠ¤ ì´ìš© ì¸ì› ì„ íƒ */}
          {formData.busService && (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                ëŒ€ì ˆë²„ìŠ¤ íƒ‘ìŠ¹ ì¸ì› <span className="text-red-500">*</span>
              </label>
              <select
                value={formData.busAttendeeCount}
                onChange={(e) => handleInputChange('busAttendeeCount', parseInt(e.target.value, 10))}
                className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-pink-300"
              >
                {Array.from({ length: formData.attendeeCount }, (_, i) => i + 1).map((count) => (
                  <option key={count} value={count}>
                    {count}ëª…
                  </option>
                ))}
              </select>
              {errors.busAttendeeCount && (
                <p className="text-red-500 text-sm mt-1">{errors.busAttendeeCount}</p>
              )}
            </div>
          )}

          {/* ëŒ€ì ˆë²„ìŠ¤ ìœ„ì¹˜ ì •ë³´ */}
          <div className="p-4 rounded-lg">
            <h4 className="text-sm font-medium text-gray-800 mb-2">ëŒ€ì ˆë²„ìŠ¤ íƒ‘ìŠ¹ ìœ„ì¹˜</h4>
            <p className="text-sm text-gray-700 mb-3">
              10ì›” 30ì¼ ì˜¤í›„ 5ì‹œ í•©ì •ì—­ 2ë²ˆ ì¶œêµ¬ ì• ì„¸ì•„íƒ€ì›Œ
            </p>
            
            {/* ì¹´ì¹´ì˜¤ë§µ ì‹¤ì œ ì§€ë„í¼ê°€ê¸° - ì„¸ì•„íƒ€ì›Œ ìœ„ì¹˜ (ì´ë¯¸ì§€ í¬ê¸°ì— ë§ì¶¤) */}
            <div className="w-full h-52 rounded-lg overflow-hidden">
              <div id="daumRoughmapContainer1755930369777" className="w-full h-full"></div>
            </div>
          </div>

          {/* ê°œì¸ì •ë³´ ì´ìš© ë™ì˜ */}
          <div className="border-t pt-4">
            <div className="bg-gray-50 p-4 mb-3">
              <h4 className="text-sm font-medium text-gray-800 mb-2">ê°œì¸ì •ë³´ ì´ìš© ë‚´ìš©</h4>
              <p className="text-xs text-gray-600 leading-relaxed">
                ì…ë ¥í•˜ì‹  ê°œì¸ì •ë³´ëŠ” ê³µì—° ì˜ˆë§¤ ë° ì•ˆë‚´, ëŒ€ì ˆë²„ìŠ¤ ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•´ ì´ìš©ë©ë‹ˆë‹¤. 
                ìˆ˜ì§‘ëœ ì •ë³´ëŠ” ê³µì—° ì¢…ë£Œ ì§í›„ íê¸°ë©ë‹ˆë‹¤.
              </p>
            </div>
            
            <label className="flex items-start space-x-2 cursor-pointer">
              <input
                type="checkbox"
                checked={formData.privacyAgreement}
                onChange={(e) => handleInputChange('privacyAgreement', e.target.checked)}
                className="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500 mt-0.5"
              />
              <span className="text-sm text-gray-700">
                ìœ„ ê°œì¸ì •ë³´ ì´ìš© ë‚´ìš©ì„ ì½ê³  ë™ì˜í•©ë‹ˆë‹¤ <span className="text-red-500">*</span>
              </span>
            </label>
            {errors.privacyAgreement && (
              <p className="text-red-500 text-sm mt-1">{errors.privacyAgreement}</p>
            )}
          </div>

          {/* ê²°ì œ ë‚´ìš© */}
          <div className="border-t pt-4">
            <div className="bg-pink-50 p-4 border border-pink-200">
              <h4 className="text-sm font-medium text-black mb-3">ê²°ì œ ë‚´ìš©</h4>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-700">ê´€ëŒ ì¸ì›:</span>
                  <span className="font-medium text-gray-800">{formData.attendeeCount}ëª…</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-700">1ì¸ë‹¹ ê°€ê²©:</span>
                  <span className="font-medium text-gray-800">â‚©20,000</span>
                </div>
                <div className="border-t border-pink-200 pt-2 mt-2">
                  <div className="flex justify-between">
                    <span className="text-black font-semibold">ì´ ê²°ì œ ê¸ˆì•¡:</span>
                    <span className="text-black font-bold text-lg">â‚©{(formData.attendeeCount * 20000).toLocaleString()}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* ë²„íŠ¼ë“¤ */}
          <div className="flex gap-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 bg-gray-300 text-gray-700 hover:bg-gray-400 transition-colors"
            >
              ì·¨ì†Œ
            </button>
            
            <button
              type="submit"
              className="flex-1 px-4 py-2 bg-pink-200 text-gray-800 hover:bg-pink-300 transition-colors font-medium"
            >
              ê²°ì œí•˜ê¸°
            </button>
          </div>
        </form>
      </div>

      {/* í•œê¸€ ê°€ìƒ í‚¤ë³´ë“œ */}
      {showKeyboard && (
        <div className="fixed inset-0 z-60 flex items-end justify-center">
          {/* í‚¤ë³´ë“œ ìœ„ìª½ ì˜ì—­ì€ íˆ¬ëª…í•˜ê²Œ (ì…ë ¥ í•„ë“œê°€ ë³´ì´ë„ë¡) */}
          <div className="absolute inset-0 bg-transparent" onClick={() => toggleKeyboard(activeField!)} />
          
          {/* í‚¤ë³´ë“œ ì»¨í…Œì´ë„ˆ */}
          <div className="bg-white w-full max-w-4xl shadow-[0_-10px_25px_-5px_rgba(0,0,0,0.1),0_-4px_6px_-2px_rgba(0,0,0,0.05)] relative z-10">
            {/* ko-customKeyboard ì»¨í…Œì´ë„ˆ */}
            <div 
              ref={keyboardRef} 
              data-keyboard-zone
              className="w-full bg-gray-100 overflow-hidden"
              style={{ 
                minHeight: '280px',
                position: 'relative'
              }}
            />
          </div>
        </div>
      )}


    </div>
  );
}
